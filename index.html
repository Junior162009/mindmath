<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>MindMath - Web</title>
<style>
  :root{
    --bg:#051126; --card:#072033; --accent:#1e90ff; --text:#e6eef8;
    --muted:#9fb3c8; font-family: Inter, Roboto, Arial, sans-serif;
  }
  html,body{height:100%; margin:0; background:var(--bg); color:var(--text);}
  .app{min-height:100vh; display:flex; align-items:center; justify-content:center; padding:16px;}
  .card{width:100%; max-width:460px; background:linear-gradient(180deg,var(--card), #022); border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,0.6); padding:14px; box-sizing:border-box;}
  h1{margin:6px 0 12px; font-size:28px; text-align:center;}
  .row{display:flex; gap:8px; align-items:center;}
  .col{display:flex; flex-direction:column; gap:8px;}
  button{background:var(--accent); color:#fff; border:none; padding:10px 12px; border-radius:8px; font-size:16px;}
  button.ghost{background:transparent; border:1px solid rgba(255,255,255,0.08);}
  select, input[type="text"]{padding:10px; border-radius:8px; border:none; font-size:16px;}
  label{font-size:14px; color:var(--muted);}
  .center{display:flex; justify-content:center; align-items:center;}
  .hidden{display:none;}
  .question{font-size:36px; text-align:center; margin:6px 0; color:var(--text);}
  .timebar{height:12px; width:100%; background:rgba(255,255,255,0.06); border-radius:8px; overflow:hidden;}
  .timefill{height:100%; width:100%; background:linear-gradient(90deg,var(--accent), #7de); transition:width 0.08s linear;}
  .kbd{display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:6px;}
  .kbd button{padding:16px; font-size:20px; border-radius:10px; background:rgba(255,255,255,0.06); color:var(--text);}
  .status{display:flex; justify-content:space-between; font-size:14px; color:var(--muted); margin-bottom:6px;}
  .footer-row{display:flex; gap:8px; margin-top:10px; justify-content:space-between;}
  .big{font-size:20px; padding:12px 16px;}
  .feedback{min-height:22px; color:#ffd380; text-align:center;}
  .gameover{font-size:22px; text-align:center; color:#ffd380;}
  @media (max-width:420px){
    .card{padding:12px;}
    .question{font-size:28px;}
  }
</style>
</head>
<body>
<div class="app">
  <div class="card" id="menuScreen">
    <h1>MindMath</h1>
    <div class="col">
      <label>Selecciona dificultad</label>
      <select id="difficulty">
        <option>Medio</option>
        <option>Fácil</option>
        <option>Difícil</option>
      </select>
      <div class="center">
        <button id="playBtn" class="big">Jugar</button>
      </div>
      <div class="center">
        <button id="helpBtn" class="ghost">Instrucciones</button>
      </div>
      <p style="color:var(--muted); font-size:13px; text-align:center; margin-top:8px;">Hecho para Android y PC — abre en el navegador</p>
    </div>
  </div>

  <div class="card hidden" id="helpScreen">
    <h1>Instrucciones</h1>
    <div style="max-height:50vh; overflow:auto; padding-right:6px;">
      <p>• Responde la multiplicación antes de que acabe el tiempo.<br>
      • Puedes usar el teclado en pantalla o el físico.<br>
      • Fallar resta vidas.<br>
      • Elige dificultad en el menú.</p>
    </div>
    <div class="row" style="justify-content:center;">
      <button id="backFromHelp" class="big ghost">Volver</button>
    </div>
  </div>

  <div class="card hidden" id="gameScreen">
    <div class="status">
      <div id="scoreLabel">Puntaje: 0</div>
      <div id="livesLabel">Vidas: 3</div>
    </div>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
      <div style="font-size:14px; color:var(--muted);">Tiempo: <span id="timeText">0s</span></div>
      <button id="pauseBtn" class="ghost">Pausa</button>
    </div>

    <div class="question" id="questionLabel">0 × 0 = ?</div>

    <div class="timebar"><div id="timeFill" class="timefill"></div></div>
    <div style="height:10px;"></div>

    <input id="answerInput" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Escribe la respuesta" style="width:100%; box-sizing:border-box;">

    <div class="feedback" id="feedback"></div>

    <div class="kbd" id="keypad">
      <button data-d="1">1</button><button data-d="2">2</button><button data-d="3">3</button>
      <button data-d="4">4</button><button data-d="5">5</button><button data-d="6">6</button>
      <button data-d="7">7</button><button data-d="8">8</button><button data-d="9">9</button>
      <button id="backBtn">⌫</button><button data-d="0">0</button><button id="okBtn">✓</button>
    </div>

    <div class="footer-row">
      <button id="restartBtn" class="ghost">Reiniciar</button>
      <button id="exitBtn" class="ghost">Salir</button>
    </div>
  </div>

  <div class="card hidden" id="gameoverScreen">
    <h1>Juego terminado</h1>
    <div class="gameover" id="finalScore">Puntaje final: 0</div>
    <div class="row" style="justify-content:center; margin-top:10px;">
      <button id="toMenuBtn" class="big">Volver al menú</button>
    </div>
  </div>
</div>

<script>
/*
  MindMath web rewrite:
  - Dificultades: Fácil/Medio/Difícil
  - Rango numérico, tiempo y vidas ajustables
  - TTS con speechSynthesis (si disponible)
  - Temporizador con barra, teclado táctil
*/

const Screens = {
  menu: document.getElementById('menuScreen'),
  help: document.getElementById('helpScreen'),
  game: document.getElementById('gameScreen'),
  gameover: document.getElementById('gameoverScreen')
};

function show(screen){
  for(const k in Screens) Screens[k].classList.add('hidden');
  screen.classList.remove('hidden');
}

// basic TTS
function speak(text){
  if('speechSynthesis' in window){
    try{
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'es-ES';
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    }catch(e){}
  }
}

// simple beep feedback (WebAudio)
const AudioCtx = (window.AudioContext || window.webkitAudioContext) ? new (window.AudioContext || window.webkitAudioContext)() : null;
function beep(freq=600, duration=0.08){
  if(!AudioCtx) return;
  const o = AudioCtx.createOscillator();
  const g = AudioCtx.createGain();
  o.type = 'sine'; o.frequency.value = freq;
  g.gain.value = 0.06;
  o.connect(g); g.connect(AudioCtx.destination);
  o.start();
  setTimeout(()=>{ o.stop(); }, duration*1000);
}

// GAME STATE
const state = {
  difficulty: 'medium',
  range_max:10, base_time:10, lives:3,
  score:0, time_remaining:0, max_time:10,
  num1:0, num2:0, correct:0,
  tickInterval: null,
  paused:false
};

const el = {
  difficulty: document.getElementById('difficulty'),
  playBtn: document.getElementById('playBtn'),
  helpBtn: document.getElementById('helpBtn'),
  backFromHelp: document.getElementById('backFromHelp'),
  scoreLabel: document.getElementById('scoreLabel'),
  livesLabel: document.getElementById('livesLabel'),
  questionLabel: document.getElementById('questionLabel'),
  timeFill: document.getElementById('timeFill'),
  timeText: document.getElementById('timeText'),
  answerInput: document.getElementById('answerInput'),
  feedback: document.getElementById('feedback'),
  keypad: document.getElementById('keypad'),
  backBtn: document.getElementById('backBtn'),
  okBtn: document.getElementById('okBtn'),
  restartBtn: document.getElementById('restartBtn'),
  exitBtn: document.getElementById('exitBtn'),
  pauseBtn: document.getElementById('pauseBtn'),
  finalScore: document.getElementById('finalScore'),
  toMenuBtn: document.getElementById('toMenuBtn')
};

// mapping difficulty select text to state
function applyDifficulty(name){
  if(name === 'Fácil'){ state.range_max = 5; state.base_time = 10; state.lives = 5; state.difficulty = 'easy'; }
  else if(name === 'Difícil'){ state.range_max = 15; state.base_time = 7; state.lives = 2; state.difficulty = 'hard'; }
  else { state.range_max = 10; state.base_time = 10; state.lives = 3; state.difficulty = 'medium'; }
}

// new round
function newRound(){
  state.num1 = rand(1, state.range_max);
  state.num2 = rand(1, state.range_max);
  state.correct = state.num1 * state.num2;
  el.questionLabel.textContent = `${state.num1} × ${state.num2} = ?`;
  state.max_time = state.base_time;
  state.time_remaining = state.max_time;
  el.answerInput.value = '';
  el.feedback.textContent = '';
  speak(`${state.num1} por ${state.num2}`);
  updateDisplays();
}

// tick (called ~10x/s)
function tick(){
  if(state.paused) return;
  state.time_remaining -= 0.1;
  if(state.time_remaining <= 0){
    state.time_remaining = 0;
    updateDisplays();
    onTimeout();
  } else {
    updateDisplays();
  }
}

function updateDisplays(){
  const frac = Math.max(0, Math.min(1, state.time_remaining / state.max_time));
  el.timeFill.style.width = `${frac*100}%`;
  el.timeText.textContent = `${Math.ceil(state.time_remaining)}s`;
  el.scoreLabel.textContent = `Puntaje: ${state.score}`;
  el.livesLabel.textContent = `Vidas: ${state.lives}`;
}

function onTimeout(){
  state.lives -= 1;
  el.feedback.textContent = 'Tiempo agotado';
  speak('Tiempo agotado');
  beep(240,0.12);
  if(state.lives <= 0) endGame();
  else setTimeout(newRound, 700);
}

function submitAnswer(){
  const txt = el.answerInput.value.trim();
  if(!txt){ el.feedback.textContent = 'Ingresa un número'; speak('Ingresa un número'); return; }
  const val = parseInt(txt, 10);
  if(isNaN(val)){ el.feedback.textContent = 'Número inválido'; speak('Número inválido'); return; }
  if(val === state.correct){
    state.score += 1;
    el.feedback.textContent = '¡Correcto!';
    speak('Correcto');
    beep(900,0.08);
  } else {
    state.lives -= 1;
    el.feedback.textContent = `Incorrecto. Era ${state.correct}`;
    speak('Incorrecto');
    beep(200,0.15);
  }
  if(state.lives <= 0) setTimeout(endGame, 600);
  else setTimeout(newRound, 700);
}

function endGame(){
  stopTicker();
  el.finalScore.textContent = `Puntaje final: ${state.score}`;
  speak(`Juego terminado. Puntaje final ${state.score}`);
  show(Screens.gameover);
}

function restartToMenu(){
  stopTicker();
  show(Screens.menu);
}

function startGame(){
  applyDifficulty(el.difficulty.value);
  state.score = 0;
  // copy lives because applyDifficulty sets state.lives
  // but we'll ensure lives value is used at start:
  const livesCopy = state.lives;
  state.lives = livesCopy;
  newRound();
  startTicker();
  show(Screens.game);
}

function startTicker(){
  stopTicker();
  state.paused = false;
  state.tickInterval = setInterval(tick, 100); // 0.1s
}

function stopTicker(){
  if(state.tickInterval){ clearInterval(state.tickInterval); state.tickInterval = null; }
}

function pauseToggle(){
  if(state.paused){
    state.paused = false;
    startTicker();
    el.feedback.textContent = 'Reanudado';
  } else {
    state.paused = true;
    stopTicker();
    el.feedback.textContent = 'Pausado';
  }
}

// helper rand
function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }

// UI events
el.playBtn.addEventListener('click', ()=>{ startGame(); });
el.helpBtn.addEventListener('click', ()=>{ show(Screens.help); });
el.backFromHelp.addEventListener('click', ()=>{ show(Screens.menu); });
el.toMenuBtn.addEventListener('click', ()=>{ show(Screens.menu); });
el.restartBtn.addEventListener('click', ()=>{ startGame(); });
el.exitBtn.addEventListener('click', ()=>{ stopTicker(); show(Screens.menu); });
el.pauseBtn.addEventListener('click', pauseToggle);
el.okBtn.addEventListener('click', submitAnswer);
el.backBtn.addEventListener('click', ()=>{ el.answerInput.value = el.answerInput.value.slice(0,-1); });
el.answerInput.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter') submitAnswer();
  if(e.key === 'Backspace') return;
  // allow digits only
  if(e.key.length === 1 && !(/[0-9]/.test(e.key))) e.preventDefault();
});

// keypad touch
el.keypad.addEventListener('click', (ev)=>{
  const d = ev.target.getAttribute('data-d');
  if(d !== null){
    el.answerInput.value += d;
  }
});

// keyboard support
window.addEventListener('keydown', (e)=>{
  if(document.activeElement === el.answerInput) return; // typing there is fine
  if(/\d/.test(e.key)) el.answerInput.value += e.key;
  else if(e.key === 'Enter') submitAnswer();
  else if(e.key === 'Backspace') el.answerInput.value = el.answerInput.value.slice(0,-1);
});

// start at menu
show(Screens.menu);

// small friendly hint: resume audio on first user gesture (mobile autoplay policies)
document.addEventListener('click', function once(){
  document.removeEventListener('click', once);
  if(AudioCtx && AudioCtx.state === 'suspended') AudioCtx.resume().catch(()=>{});
});

</script>
  <script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js")
    .then(() => console.log("Service Worker registrado ✅"))
    .catch(err => console.log("Error al registrar SW:", err));
}
</script>
</body>
</html>
